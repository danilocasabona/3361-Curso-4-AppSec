name: Create Issue on TruffleHog Findings

on:
  workflow_run:
    workflows: ["TruffleHog Scan Test"]
    types:
      - completed

jobs:
  create-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Check for secrets
        run: |
          if grep -q "Found" trufflehog-results.txt; then
            echo "SECRETS_DETECTED=true" >> $GITHUB_ENV
          else
            echo "SECRETS_DETECTED=false" >> $GITHUB_ENV
          fi

      - name: Create GitHub Issue if secrets found
        if: env.SECRETS_DETECTED == 'true'
        run: |
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/issues \
            -d '{
              "title": "‚ö†Ô∏è TruffleHog Encontrou Segredos no C√≥digo!",
              "body": "## üö® Alerta de Seguran√ßa! üö®\n\nO TruffleHog detectou credenciais ou segredos em um Pull Request recente.\n\n- **Workflow**: TruffleHog Scan Test\n- **Status**: ‚ùå Segredos encontrados\n- **Autor**: @${{ github.actor }}\n- **PR/Commit**: [Clique aqui](${{ github.event.workflow_run.html_url }})\n\nüî¥ **Revise os arquivos e remova qualquer informa√ß√£o sens√≠vel antes de prosseguir.**",
              "labels": ["security", "trufflehog", "high-priority"]
            }'