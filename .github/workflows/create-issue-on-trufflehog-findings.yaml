name: Create Issue on TruffleHog Findings

on:
  workflow_run:
    workflows: ["TruffleHog Scan"]
    types:
      - completed

permissions:
  issues: write

jobs:
  create-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Download Scan Results
        uses: actions/download-artifact@v4
        with:
          name: trufflehog-results
          path: trufflehog-results.txt

      - name: Check for Secrets
        run: |
          if [ -f trufflehog-results/trufflehog-results.txt ]; then
            echo "‚úÖ Artefato encontrado: trufflehog-results.txt"
            if grep -q "Found" trufflehog-results/trufflehog-results.txt; then
              echo "SECRETS_DETECTED=true" >> $GITHUB_ENV
            else
              echo "SECRETS_DETECTED=false" >> $GITHUB_ENV
            fi
          else
            echo "‚ö†Ô∏è Nenhum artefato encontrado. O workflow ser√° finalizado."
            exit 1
          fi

      - name: Create GitHub Issue if secrets found
        if: env.SECRETS_DETECTED == true
        run: |
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/danilocasabona/3361-Curso-4-AppSec/issues \
            -d '{
              "title": "‚ö†Ô∏è TruffleHog Encontrou Segredos!",
              "body": "üö® O TruffleHog detectou credenciais ou segredos no c√≥digo!\n\nüîé **Workflow**: TruffleHog Scan\n‚ùå **Status**: Segredos encontrados\nüë§ **Autor**: @${{ github.actor }}\n\nüîó [Clique aqui para ver os detalhes](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n‚ö†Ô∏è **Revise os arquivos e remova informa√ß√µes sens√≠veis antes de prosseguir!**",
              "labels": ["security", "trufflehog", "high-priority"]
            }'