name: Create Issue on TruffleHog Findings

on:
  workflow_run:
    workflows: ["TruffleHog Scan Test"]
    types:
      - completed

jobs:
  create-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Download scan results
        uses: actions/download-artifact@v3
        with:
          name: trufflehog-results

      - name: Check for secrets
        id: check_secrets
        run: |
          if grep -q "Found" trufflehog-results.txt; then
            echo "SECRETS_DETECTED=true" >> $GITHUB_ENV
          else
            echo "SECRETS_DETECTED=false" >> $GITHUB_ENV
          fi

      - name: Create GitHub Issue if secrets found
        if: env.SECRETS_DETECTED == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueTitle = "üö® TruffleHog Encontrou Segredos no C√≥digo!";
            const issueBody = `
            ## üö® Alerta de Seguran√ßa! üö®

            O TruffleHog detectou credenciais ou segredos em um Pull Request recente.

            - **Workflow**: TruffleHog Scan Test  
            - **Status**: ‚ùå Segredos encontrados  
            - **Autor**: @${{ github.actor }}  
            - **PR/Commit**: [Clique aqui](${{ github.event.workflow_run.html_url }})  

            üî¥ **Revise os arquivos e remova qualquer informa√ß√£o sens√≠vel antes de prosseguir!**
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ["security", "trufflehog", "high-priority"]
            });